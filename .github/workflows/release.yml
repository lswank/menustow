name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-sign-notarize:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Task
        run: brew install go-task/tap/go-task

      - name: Import signing certificate
        env:
          SIGNING_CERT_BASE64: ${{ secrets.MACOS_CERT_BASE64 }}
          SIGNING_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$SIGNING_CERT_BASE64" | base64 --decode > signing.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import signing.p12 -k build.keychain -P "$SIGNING_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-keychain-settings -t 21600 -u build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security list-keychains -d user -s build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Configure notarytool
        env:
          NOTARY_PROFILE: ${{ secrets.NOTARY_PROFILE }}
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
        run: |
          echo "$ASC_PRIVATE_KEY" > AuthKey.p8
          xcrun notarytool store-credentials "$NOTARY_PROFILE" \
            --key "$ASC_KEY_ID" \
            --issuer "$ASC_ISSUER_ID" \
            --key "AuthKey.p8"

      - name: Archive
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
          SIGN_IDENTITY: ${{ secrets.SIGN_IDENTITY }}
        run: task archive

      - name: Package (for notarization)
        run: task package

      - name: Notarize
        env:
          NOTARY_PROFILE: ${{ secrets.NOTARY_PROFILE }}
        run: task notarize

      - name: Staple and repackage
        run: |
          task staple
          task package

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: menustow-zip
          path: dist/menustow-*.zip

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ZIP_PATH="$(ls dist/menustow-*.zip | head -n 1)"
          gh release upload "${{ github.event.release.tag_name }}" "$ZIP_PATH" --clobber
